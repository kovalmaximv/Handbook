[Назад](../README.md)

1. [Введение](#надежность,-масштабируемость-и-удобство-в-сопровождении)
2. [Надежность](#надежность)
3. [Масштабируемость](#масштабируемость)  
   3.1. [Процентили](#процентили)
   3.2. [Как справиться с нагрузкой](#как-справиться-с-нагрузкой)
4. [Удобство сопровождения](#удобство-сопровождения)

# Надежность, масштабируемость и удобство в сопровождении
В наше время большинство приложений являются _высоконагруженными данными_ (data-intensive, DIA). Существуют еще 
приложения _высоконагруженные вычислениями_ (compute-intensive, CIA), но они встречаются в узко специализированных 
предметных областях.

> :exclamation: Говоря о высоконагруженных приложениях, мы будем иметь в виду приложения высоконагруженные данными. 

Высоконагруженные приложения обычно имеют схожие потребности в функциональности, отчего создаются из стандартных блоков:
1) Хранение данных (_базы данных_)
2) Хранение ресурсоёмких операций (_кеш_)
3) Поиск в данных по ключевым словам или индексам (_поисковые индексы_)
4) Асинхронная обработка процессов совместными сервисами (_потоковая обработка_)
5) Периодическая обработка больших объемов накопленных данных (_пакетная обработка_)

Основная сложность в реализации такого функционала в том, что необходимо выбрать среди множества инструментов 
для решения всех этих задач. Каждый инструмент разрабатывался для решения определенной боли разработчиков. В некоторых
случаях абсолютно верной комбинации инструментов для решения задачи может попросту не быть.

Для того чтобы научиться грамотно проектировать высоконагруженные приложения (и выбирать правильные инструменты), 
нужно понимать основные характеристики информационных систем: **надежность**, **масштабируемость** и 
**удобство в сопровождении**.

## Надежность
**Надежность** - обеспечение правильной работы системы даже в случае сбоев.

От надежной системы ожидается следующее:
1) Приложение выполняет ожидаемую функцию
2) Приложение способно выдержать ошибочные пользователем действия
3) Его производительность достаточно высока для текущей нагрузки
4) Система предотвращает любой неразрешенный доступ


Возможные проблемы связанные с надежностью называются _сбои_. На практике невозможно разработать систему на 100% 
устойчивой к любым сбоям. Это всегда баланс между тем, сколько денег вы можете потратить на разработку и терпимостью
к различным сбоям. На деле **достаточно сделать систему устойчивой к сбоям, которые могут привезти к отказу 
работоспособности всей системы**.

Сбои бывают:
1) _Аппаратные_ - связанные непосредственно с железом. Самые редкие типы сбоев. Решаются путем избыточности данных (RAID 
массивы или дублирующиеся виртуальные машины), либо переходом на более надежного поставщика серверных мощностей.
2) _Программные_ - связанные с ошибками в коде. Быстрого решения данной проблемы нет. Может помочь высокая культура 
разработки и более высококлассные разработчики.
3) _Человеческий фактор_ - различные ошибки команды сопровождения. Могут помочь следующие шаги: минимизировать 
человеческий фактор при сопровождении, обеспечить легкое восстановление после появления ошибок, настроить мониторинг, 
повышение квалификации команды сопровождения.

Надежность важна в любом приложении, поскольку может вести за собой репутационные потери или утраченную потенциальную 
прибыль на время простоя системы.

## Масштабируемость
**Масштабируемость** - наличие стратегий поддержания хорошей производительности при повышении уровня нагрузки. 

**Бессмысленно** просто вешать ярлык 'система Х масштабируема'. Масштабируемость системы измеряется в 
качестве ответов на вопрос **'что мы будем делать, когда возрастет нагрузка'**. 

Чтобы говорить о масштабируемости системы и способах ее увеличения, сначала необходимо понять, какие **параметры нагрузки**
существуют в этой системе. Именно эти параметры мы и будем стараться оптимизировать. Поэтому столь **важно правильно их 
выбрать**, от этих параметров будет зависеть результат работы архитекторов. Если выбрать их неправильно, то в лучшем
случае, что мы получим - производительность системы останется на прежнем уровне.

Зачастую для параметров нагрузки выбираются [время отклика](../Definitions.md#время-отклика) основного функционала 
системы. Для twitter это например время отклика для написания твита и получения домашней ленты твитов. 

#### Процентили
Довольно часто смотрят на арифметическое среднее время отклика, однако арифметическое среднее не совсем лучший вариант
для этого. Для этого лучше использовать **процентили**. Если отсортировать список времени по возрастанию, то **медиана**
(или 50-й процентиль) будет означать, что половина запросов выполнились быстрее, а половина медленнее.

Чтобы выяснить, насколько плохи аномальные значения, используют процентили p95, p99, p99.9. Например, p99.9 
показывает время, быстрее которого справились 99.9% запросов. Многие крупные компании оптимизируют именно этот 
процентиль, однако оптимизация на уровне 99.9 процентиля очень дорогая и не приносит большого профита. Как правило, 
большое значение 99.9 процентиль имеет во внутренних сервисах, так как мы не можем отдать ответ пользователю, пока 
внутренние сервисы не вернут свой ответ.

Процентили так же часто используются в SLO (требования к уровню предоставления сервиса) и SLA (соглашении об уровне 
предоставлении сервиса). В SLA например может быть сказано, что сервис рассматривается как функционирующий нормально, 
если его медианное время отклика 200мс, а 99-й процентиль меньше 1с, а работать сервис должен нормально 99.9% времени.

Такие соглашения нужны, чтобы позже с поставщика можно взять неустойку за нерабочий нормально сервис.

#### Как справиться с нагрузкой
Для этого применяют [горизонтальное](../Definitions.md#горизонтальное-масштабирование) и
[вертикальное](../Definitions.md#горизонтальное-масштабирование) масштабирование. Некоторые инструменты (напр. k8s) 
позволяют настроить автоматическое масштабирование при превышении лимита использования определенного ресурса.

## Удобство сопровождения
**Удобство сопровождения** - облегчение жизни команды разработки и сопровождения.

Большая часть стоимости программного обеспечения состоит из поддержки и сопровождения существующих систем. Помимо 
прочего, наша задача - сделать так, чтобы сопровождать нашу систему было легко и дешево. Поможет нам этого добиться 
следующие принципы проектирования систем:

**Удобство эксплуатации**  
Необходимо упростить жизнь команде сопровождения (в некоторых компаниях их называют командой саппортов). Эта команда 
занимается следующим:
1) Мониторинг состояния системы и восстановление сервиса в случае отказа сервиса
2) Выяснение причин проблем, например отказ сервиса или проблемы с производительностью
3) Поддержание актуальности программного обеспечения и платформ (в том числе безопасности)
4) Отслеживание влияния различных систем друг на друга
5) Перенос приложения с одной платформы на другую

Чтобы команде сопровождения жилось проще, система должна иметь:
1) Хороший мониторинг и систему логирования
2) Независимость от отдельных машин
3) Качественная документация 
4) Разумное поведение (выполняющее требования) по умолчанию
5) Самовосстановление, по возможности

**Простота**  
Необходимо избавляться от излишней запутанности и сложности вашей системы, поскольку это может привести к увеличению
сроков разработки и появлению багов. Хороший способ избавления от сложности - абстракция и инкапсуляция. Отдельный 
сервис должен выполнять отдельно стоящую задачу, иметь понятный и ограниченный своими задачами интерфейс. Реализация 
в таком случае не должна волновать пользователей такого абстрактного сервиса. Однако найти такую абстракцию бывает 
сложно.

**Возможность внесения изменений**  
Ваша система будет постоянно меняться под постоянно меняющиеся требования бизнеса и рынка. Поэтому важно спроектировать
систему готовой к этим изменениям. Однако степень возможности и легкости изменений напрямую вытекает из предыдущих двух
пунктов. Если систему легко поддерживать и она проста настолько, насколько это возможно - ее будет легко расширять и 
вносить в нее изменения. 