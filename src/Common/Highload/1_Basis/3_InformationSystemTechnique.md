[Назад](./README.md)

# Подсистемы хранения и извлечения данных

В данной главе мы рассмотрим, как базы данных работают под капотом. Вам, как разработчику это может быть интересно
(и полезно) с практической стороны вопроса. Если вы будете знать нюансы внутренней работы БД, то сможете выбрать
самую оптимальную для вашего конкретного случая. Мы рассмотрим две основные системы хранения данных: журналированные
(log-structured storage engine) и постраничные (page-oriented storage engine), например B-деревья.

## Основные движки хранения данных (Storage engines)
Для начала представим самую простую в мире БД, состоящую из двух комманд:

```bash
#!/bin/bash

db_set() {
  echo "$1,$2" >> database
}

db_get() {
  grep "^$1," database | sed -e "s/^$1,//" | tail -n 1
}
```

Это реализация хранилища "ключ-значение". Команда `db_set key value` необходима для сохранения key и value в 
базе данных. Затем нужно вызвать `db_get key` для поиска последнего значения, записанного для данного ключа. И это 
работает! Каждый вызов `db_set` приводит к дописыванию данных в конец файла, а для поиска данных берется самая 
последняя запись с данным ключом. 

Журналированный движок БД используются очень похожий на наш `db_set` механизм. Упрощенно, они просто добавляют в конец 
файла новые значения, а потом читают самое последнее значение. Такой подход дает довольно большую производительность, 
поскольку дописывание в конец файла - быстрая операция.

С другой стороны, производительность нашей функции `db_get` - ужасна в случае большого количества записей в БД. Каждый 
раз мы просматриваем всю базу от начала до конца, чтобы получить значение. Для эффективного поиска ключа в БД необходима
другая структура - _индекс_. Общая идея индекса заключается в дополнительном хранении определенных метаданных, служащих
для быстрого поиска необходимого ключа. Может понадобиться несколько индексов, если поиск может вестись по нескольким 
полям. 

Любые индексы обычно замедляют запись, так как индекс тоже приходится обновлять всякий раз при записи на диск. Это 
важный компромисс между скоростью поиска и записи. По этой причине БД не индексируют все поля по умолчанию, а оставляют
решение по индексации полей разработчику.