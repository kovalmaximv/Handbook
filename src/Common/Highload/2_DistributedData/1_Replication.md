# Репликация
Репликация - хранение копии одних и тех же данных на нескольких машинах. Существует несколько причин для репликации:
1) Ради хранения данных географически ближе к пользователю
2) Чтобы система могла работать при отказе некоторых систем
3) Для увеличения количества машин, способных принимать запросы на чтение

Основная сложность репликации в том, чтобы поддерживать репликации актуальными. Существуют при популярных алгоритма 
решения этой задачи: репликация _с одним ведущим узлом_ (single-leader), _с несколькими ведущими_ (multi-leader) и 
_без ведущего узла_ (leaderless). 

## Ведущие узлы
Каждая операция записи в базу должна учитываться всеми репликами. Наиболее распространенное решение - репликация с
ведущим узлом (_leader-based replication_). Ее алгоритм:

1) Одна из реплик становится _ведущей_ (leader). Запись происходит только в ведущую реплику.
2) Другие реплики называются _ведомыми_ (followers). Ведущая реплика отправляет им все свои изменения и ведомые все 
повторяют.
3) Для чтения можно обратиться к ведущему или ведомому узлу.

![img.png](../../../../img/highload/leader_replica.png)

Такой режим работы встроен во множество реляционных БД (PostgreSQL, MySQL, Oracle, SQL Server) и некоторые 
нереляционные БД (MongoDB, Espresso). Такой механизм так же используется в брокерах сообщений (Kafka, RabbitMQ)

#### Синхронность репликаций
Ведомая репликация называется синхронной, если ведущий узел ждет, пока репликация не повторит те же шаги. Если ожидания 
не происходит, ведомая репликация не синхронна.

Узел 1 в примере синхронный, узел 2 нет.  
![img.png](../../../../img/highload/sync_replicas.png)

Преимущество синхронности - всегда есть реплика, в точности повторяющая лидера. Теоретически такая реплика может 
подменить лидера в случае сбоя последнего. Недостаток - если ведомый узел не отвечает, приостанавливается работы 
системы, запись не сможет отработать.

Многие системы хранения данных позволяют выбрать полусинхронный вариант: когда ведомая синхронная реплика не отвечает,
на ее место выбирается одна из рабочих реплик (в случае необходимости в реплику дописываются данные с лидера).

#### Создание новых ведомых узлов