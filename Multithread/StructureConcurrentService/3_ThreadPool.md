# Применение пулов потоков

## Проблемные задачи в пуле потоков
Пулы потоков лучше всего работают, когда задачи однородны и независимы. Предоставление зависимых задач может привести 
к взаимной блокировке, если пул ограничен. К счастью, запросы в серверных приложениях соответствуют этим ограничениям.

#### Взаимная блокировка с ресурсным голоданием
Если в пуле выполняются зависимые друг от друга задачи, то они могут быть заперты взаимной блокировкой. Например, все 
потоки выполняют задачи, которые заблокированы в ожидании других задач из рабочей очереди.

Взаимная блокировка с ресурсным голоданием (thread starvation deadlock) может возникать всякий раз, когда задача 
пула инициирует неограниченное по времени блокирующее ожидание действия другой задачи пула.

Самый простой способ избежать подобной проблемы - не использовать зависимые друг от друга задачи в пуле потоков. 
Если избавиться от этого невозможно, то можно увеличить размер пула потоков. Таким образом в увеличенный пул влезут 
задачи, выполнения которых ожидают заблокированные потоки.

Одна стоит помнить, что помимо явных лимитов на размер пула, существуют и неявные ограничения на другие ресурсы. Самый 
простой пример - количество соединений JDBC. Если приложению доступно 10 соединений, то делать пул из 11 
потоков бессмысленно.

#### Длительные задачи
Если размер пула слишком пал, а длительных задач слишком много, то может пострадать отзывчивость системы.

Один из вариантов решения проблемы - использование хронометрированных версий ожидания ресурсов, вместо неограниченных. 
Если время ожидания истекло, задачу можно пометить как безуспешную и отменить, либо поставить в конец очереди и 
попробовать ее выполнить снова.

## Определение размера пула потоков
Важно правильно определить оптимальный размер пула потоков. 

В слишком большом пуле потоки конфликтуют за ресурсы процессора и памяти. В слишком малом потоке страдает 
пропускная способность, хотя процессоры остаются невостребованы.

Чтобы правильно определить размер пула важно понимать ресурсные реалии и характер задач. Необходимо понимать 
количество процессоров, памяти, выполняют задачи вычисления или в основном ввод-вывод, требуют ли они дефицитных 
ресурсов. Если у вас имеются разные категории задач с очень разными формами поведения, то следуют рассмотреть 
возможность использования нескольких пулов. Свой для каждого типа задачи.

Для вычислительноемких задачи `Ncpu` процессорная система обычно достигает оптимальной работы с пулом `Ncpu + 1`. Даже 
вычислительноемкие задачи иногда берут паузы по какой-либо причине, поэтому лишний поток защищает от 
недоиспользования процессорных циклов.

Для задач, которые включают блокирующие операции (например ввод-вывод) требуется бОльший пул. Оптимальный размер пула 
в таком случае определяется по формуле:

![thread_pool_size_formula](../../img/multithread/thread_pool_size_formula.jpg)

где  
Ncpu - число процессоров
Ucpu - целевая задействованность процессоров (0 < Ucpu < 1)
W/C - отношения времени ожидания ко времени вычисления

Данная формула является лишь основой для составления своей формулы для каждого конкретного случая. Скорее всего в вашем
случае будут и другие ограниченные ресурсы (память, сеть, подключения к бд, etc). К счастью, вычислять ограничения на
размер пула для этих типов ресурсов проще: разделите суммарное кол-во ресурса на кол-во ресурса необходимого 
одному потоку. Полученное число будет являться верхней границей размера пула потоков.
 
## Конфигурирование класса ThreadPoolExecutor